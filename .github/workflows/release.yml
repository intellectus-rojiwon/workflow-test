name: Release 🔖

on:
  workflow_dispatch:
    inputs:
      name:
        required: false
        type: string
      version:
        required: false
        type: string
      development:
        required: true
        type: boolean
        default: true
      production:
        required: true
        type: boolean
        default: false
      image:
        required: true
        type: boolean
        default: false
      lambda:
        required: true
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  project:
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.project.outputs.name }}
      version: ${{ steps.project.outputs.version }}

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@main

      - name: Init Project
        id: project
        run: |
          if [ -z "${{ inputs.name }}" ]; then
            NAME=$(echo ${{ github.repository }} | cut -d '/' -f 2)
          else
            NAME=${{ inputs.name }}  
          fi

          if [ -z "${{ inputs.version }}" ]; then
            VERSION=$(node -p "require('./package.json').version")
          else
            VERSION=${{ inputs.version }}
          fi

          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          echo "::notice title=Project Info::$NAME:$VERSION"

  image:
    needs:
      - project
    uses: ./.github/workflows/image.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      role_to_assume: ${{ vars.AWS_ROLE }}
      ecr_repository: ${{ needs.project.outputs.name }}
      version: ${{ needs.project.outputs.version }}
      development: ${{ inputs.development }}
      produnction: ${{ inputs.production }}
      push: ${{ inputs.image }}

  lambda_development:
    needs:
      - project
      - image
    if: inputs.lambda && inputs.development
    uses: ./.github/workflows/lambda.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      role_to_assume: ${{ vars.AWS_ROLE }}
      name: ${{ needs.project.outputs.name }}
      version: dev
      image_uri: ${{ needs.image.outputs.image_uri }}
      memory: 1024
      architectures: x86_64
      ephemeral_storage: 512
      timeout: 6

  lambda_production:
    needs:
      - project
      - image
    if: inputs.lambda && inputs.production
    uses: ./.github/workflows/lambda.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      role_to_assume: ${{ vars.AWS_ROLE }}
      name: ${{ needs.project.outputs.name }}
      version: prod
      image_uri: ${{ needs.image.outputs.image_uri }}
      memory: 4096
      architectures: x86_64
      ephemeral_storage: 512
      timeout: 30
      provisioned_concurrency: 3
