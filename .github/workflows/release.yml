name: Release 🔖

on:
  workflow_dispatch:
    inputs:
      name:
        required: false
        type: string
      version:
        required: false
        type: string
      development:
        required: true
        type: boolean
        default: true
      production:
        required: true
        type: boolean
        default: false
      image:
        required: true
        type: boolean
        default: true
      lambda:
        required: true
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  project:
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.project.outputs.name }}
      version: ${{ steps.project.outputs.version }}

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@main

      - name: Init Project
        id: project
        run: |
          if [ -z "${{ inputs.name }}" ]; then
            NAME=$(echo ${{ github.repository }} | cut -d '/' -f 2)
          else
            NAME=${{ inputs.name }}  
          fi

          if [ -z "${{ inputs.version }}" ]; then
            VERSION=$(node -p "require('./package.json').version")
          else
            VERSION=${{ inputs.version }}
          fi

          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          echo "::notice title=Project Info::$NAME:$VERSION"

  image:
    needs:
      - project
    uses: ./.github/workflows/ecr.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      assume_role_arn: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ASSUME_ROLE }}"
      ecr_repository: ${{ needs.project.outputs.name }}
      image_tag: ${{ needs.project.outputs.version }}
      override: false

  lambda_development:
    needs:
      - project
      - image
    if: inputs.lambda && inputs.development
    uses: ./.github/workflows/lambda.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      assume_role_arn: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ASSUME_ROLE }}"
      function_name: ${{ needs.project.outputs.name }}-dev
      ecr_aws_region: ${{ vars.AWS_REGION }}
      ecr_registry_id: "${{ vars.AWS_ACCOUNT_ID }}"
      ecr_repository: ${{ needs.project.outputs.name }}
      image_tag: ${{ needs.project.outputs.version }}
      architectures: x86_64
      memory: 1024
      ephemeral_storage: 512
      timeout: 6
      environment: |
        { NODE_ENV: "production" }

  lambda_production:
    needs:
      - project
      - image
    if: inputs.lambda && inputs.production
    uses: ./.github/workflows/lambda.yml
    with:
      aws_region: ${{ vars.AWS_REGION }}
      assume_role_arn: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ASSUME_ROLE }}"
      function_name: ${{ needs.project.outputs.name }}-prod
      ecr_aws_region: ${{ vars.AWS_REGION }}
      ecr_registry_id: "${{ vars.AWS_ACCOUNT_ID }}"
      ecr_repository: ${{ needs.project.outputs.name }}
      image_tag: ${{ needs.project.outputs.version }}
      architectures: x86_64
      memory: 4096
      ephemeral_storage: 512
      timeout: 30
      provisioned_concurrency: 3
