# This is a basic workflow to help you get started with Actions

name: Release üîñ

# Controls when the workflow will run
on:
  workflow_dispatch:
    inputs:
      development:
        description: Development Stage
        required: true
        default: true
        type: boolean
      production:
        description: Production Stage
        required: true
        default: false
        type: boolean
      image: # stageÎßàÎã§ Í∞ÅÍ∞Å ÎûåÎã§Ìï®ÏàòÎäî Îî∞Î°ú Í∞ñÎäîÎã§, development, production tag Î∂ÄÏó¨
        description: ECR Docker Image
        required: true
        default: false
        type: boolean
      lambda:
        required: true
        default: true
        type: boolean
      swagger: # Ìï≠ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏
        required: true
        default: false
        type: boolean
      sdk: # Î≤ÑÏ†ÑÎ≥Ñ Î∞∞Ìè¨, development, production tag Î∂ÄÏó¨, npm view Î™ÖÎ†πÏñ¥Î°ú Í∏∞Ï°¥ Î≤ÑÏ†Ñ Î∞∞Ìè¨ Ïú†Î¨¥ ÌôïÏù∏
        required: true
        default: false
        type: boolean

permissions:
  id-token: write
  contents: write
  packages: write

jobs:
  project:
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.setup.outputs.name }}
      version: ${{ steps.setup.outputs.version }}
      aws-access-key-id: ${{ steps.credentials.outputs.aws-access-key-id }}
      aws-secret-access-key: ${{ steps.credentials.outputs.aws-secret-access-key }}
      aws-session-token: ${{ steps.credentials.outputs.aws-session-token }}

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@main

      - name: project info
        id: setup
        run: |
          NAME=$(echo ${{ github.repository }} | cut -d '/' -f 2)
          VERSION=$(node -p "require('./package.json').version")
          echo "name=$NAME" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_ENV

          echo "::notice title=Project Info::$NAME:$VERSION"

      - name: Configure AWS credentials üîí
        id: credentials
        uses: aws-actions/configure-aws-credentials@main
        with:
          role-to-assume: ${{ vars.AWS_ROLE }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Log User Arn
        run: aws sts get-caller-identity --query 'Arn'

  image:
    runs-on: ubuntu-latest
    needs:
      - project
    outputs:
      uri: ${{ steps.ecr.outputs.registry }}/${{ needs.project.outputs.name }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ needs.project.outputs.aws-access-key-id }}
      AWS_SECRET_ACCESS_KEY: ${{ needs.project.outputs.aws-secret-access-key }}
      AWS_SESSION_TOKEN: ${{ needs.project.outputs.aws-session-token }}

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@main

      - name: Login to Amazon ECR üîí
        id: ecr
        uses: aws-actions/amazon-ecr-login@main

      - name: Check Repository
        run: |
          aws ecr describe-repositories --repository-names ${{ needs.project.outputs.name }} || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY --region ${{ vars.AWS_REGION }}

      - name: Build & Push Docker Image ‚ú®
        if: github.event.inputs.image == 'true'
        run: |
          if ! aws ecr describe-images --repository-name $ECR_REPOSITORY --image-ids imageTag=$IMAGE_TAG > /dev/null 2>&1; then
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            echo "::notice title=Image Created::$name:$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          fi

          if [ ${{ github.event.inputs.development }} == "true" ]; then
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:dev
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:dev

            echo "::notice title=Image Created::$name:$ECR_REGISTRY/$ECR_REPOSITORY:dev"
          fi

          if [ ${{ github.event.inputs.production }} == "true" ]; then
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:prod
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:prod

            echo "::notice title=Image Created::$name:$ECR_REGISTRY/$ECR_REPOSITORY:prod"
          fi
        env:
          ECR_REPOSITORY: ${{ needs.project.outputs.name }}
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.project.outputs.version }}

  lambda_development:
    if: github.event.inputs.lambda == 'true' && github.event.inputs.development == 'true'
    runs-on: ubuntu-latest
    needs:
      - project
      - image
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ needs.project.outputs.aws-access-key-id }}
      AWS_SECRET_ACCESS_KEY: ${{ needs.project.outputs.aws-secret-access-key }}
      AWS_SESSION_TOKEN: ${{ needs.project.outputs.aws-session-token }}

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@main

      - name: Lambda Deploy
        run: |
          LAMBDA_VERSION=$(aws lambda update-function-code --function-name $FUNCTION_NAME --image-uri $IMAGE_URI --query 'Version' --output text || \
            aws lambda create-function --function-name $FUNCTION_NAME --package-type Image --code ImageUri=$IMAGE_URI \
              --region ${{ vars.AWS_REGION }} \
              --memory-size 1024 --runtime nodejs20.x --architectures x86_64 --ephemeral-storage Size=512 \
              --timeout 6 --query 'Version' --output text)

          echo "::notice title=Lambda Deployed::$FUNCTION_NAME:$LAMBDA_VERSION"
        env:
          FUNCTION_NAME: ${{ needs.project.outputs.name }}-dev
          IMAGE_URI: ${{ needs.image.outputs.uri }}:dev

      - name: Update Lambda URL
        run: |
          FUNCTION_HOST=$(aws lambda get-function-url-config --function-name $FUNCTION_NAME --auth-type NONE --query 'FunctionUrl' --output text || \
          aws lambda create-function-url-config --function-name $FUNCTION_NAME --auth-type NONE --query 'FunctionUrl' --output text)

          echo "::notice title=Development Host::$FUNCTION_HOST"
        env:
          FUNCTION_NAME: ${{ needs.project.outputs.name }}-dev

  lambda_production:
    if: github.event.inputs.lambda == 'true' && github.event.inputs.production == 'true'
    runs-on: ubuntu-latest
    needs:
      - project
      - image
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ needs.project.outputs.aws-access-key-id }}
      AWS_SECRET_ACCESS_KEY: ${{ needs.project.outputs.aws-secret-access-key }}
      AWS_SESSION_TOKEN: ${{ needs.project.outputs.aws-session-token }}

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@main

      - name: Configure AWS credentials üîí
        uses: aws-actions/configure-aws-credentials@main
        with:
          aws-region: ${{ vars.AWS_REGION }}

      - name: Lambda Deploy
        id: function
        run: |
          LAMBDA_VERSION=$(aws lambda update-function-code --function-name $FUNCTION_NAME --image-uri $IMAGE_URI --query 'Version' --output text || \
            aws lambda create-function \
              --function-name $FUNCTION_NAME \
              --package-type Image --code ImageUri=$IMAGE_URI \
              --region ${{ vars.AWS_REGION }} \
              --architectures x86_64 \
              --runtime nodejs20.x \
              --memory-size 4096 \
              --ephemeral-storage Size=512 \
              --timeout 30 \
              --query 'Version' --output text)

          echo "::notice title=Lambda Deployed::$FUNCTION_NAME:$LAMBDA_VERSION"
          echo "version=$LAMBDA_VERSION" >> $GITHUB_ENV
        env:
          FUNCTION_NAME: ${{ needs.project.outputs.name }}-prod
          IMAGE_URI: ${{ needs.image.outputs.uri  }}:prod

      - name: Provisioned Concurrency
        run: |
          aws lambda update-alias --function-name $FUNCTION_NAME --name provisioned --function-version ${{ steps.function.outputs.version }} || \
          aws lambda create-alias --function-name $FUNCTION_NAME --name provisioned --function-version ${{ steps.function.outputs.version }}

          aws lambda put-provisioned-concurrency-config \
            --function-name $FUNCTION_NAME \
            --qualifier provisioned
            --provisioned-concurrent-executions 3
        env:
          FUNCTION_NAME: ${{ needs.project.outputs.name }}-prod

      - name: Update Lambda URL
        run: |
          FUNCTION_HOST=$(aws lambda get-function-url-config --function-name $FUNCTION_NAME --auth-type NONE --query 'FunctionUrl' --output text || \
          aws lambda create-function-url-config --function-name $FUNCTION_NAME --auth-type NONE --query 'FunctionUrl' --output text)

          echo "::notice title=Development Host::$FUNCTION_HOST"
        env:
          FUNCTION_NAME: ${{ needs.project.outputs.name }}-prod

  # Î≤ÑÏ†ÑÏóê Ìï¥ÎãπÌïòÎäî Release note, npm lib ÏóÜÎã§Î©¥ Î∞∞Ìè¨
  # npm tagÎßå Î≥ÑÎèÑÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
